<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ—Ç –• –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –ø–æ–¥–±–µ—Ä–∏—Ç–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–¥ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Ä–∏—Å–∫–∞.">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî –• –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo"><a href="index.html" class="logo-link">–• –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</a></div>
            <nav class="nav" id="mainNav">
                <a href="index.html#smart-money" class="nav-link">Smart Money</a>
                <a href="index.html#algo-trading" class="nav-link">Algo trading</a>
                <a href="index.html#crypto" class="nav-link">Crypto</a>
                <a href="calc.html" class="nav-link">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a>
                <a href="macro.html" class="nav-link">–ú–∞–∫—Ä–æ–º–æ–¥–µ–ª–∏</a>
                <a href="index.html#about" class="nav-link">–û –Ω–∞—Å</a>

            </nav>
            <button class="burger" id="burgerBtn" aria-label="–ú–µ–Ω—é">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Disclaimer Banner -->
    <div class="disclaimer-banner">
        ‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π (–ò–†) –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–§.
    </div>

    <!-- Main Content -->
    <main class="calculator-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤—ã—à–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ -->
        <section class="section page-header">
            <div class="container">
                <h2 class="section-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è</h2>
            </div>
        </section>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –Ω–∏–∂–µ -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar">
                <div class="progress-step active" data-step="1">1</div>
                <div class="progress-step" data-step="2">2</div>
                <div class="progress-step" data-step="3">3</div>
                <div class="progress-step" data-step="4">4</div>
            </div>
            <div class="progress-label" id="progressLabel">–®–∞–≥ 1 –∏–∑ 4</div>
        </div>

        <!-- –®–∞–≥–∏ -->
        <div class="step" id="step-profile" data-step="1">
            <div class="container">
                <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å —Ä–∏—Å–∫–∞</h2>
                <p>–ü—Ä–æ—Å—Ç–æ –∏–∑–≤–ª–µ–∫–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã–≥–æ–¥—É –∏–∑ —Å–≤–æ–∏—Ö –∞–∫—Ç–∏–≤–æ–≤ ‚Äî —Å –ø–æ–º–æ—â—å—é –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π, –Ω–∏–∑–∫–∏—Ö –∑–∞—Ç—Ä–∞—Ç –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.</p>
                <div class="profile-cards">
                    <div class="profile-card" data-profile="conservative">
                        <h3>–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π</h3>
                        <p>–ú–∏–Ω–∏–º—É–º —Ä–∏—Å–∫–∞, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥</p>
                    </div>
                    <div class="profile-card" data-profile="balanced">
                        <h3>–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π</h3>
                        <p>–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫, —Ä–æ—Å—Ç + –¥–æ—Ö–æ–¥</p>
                    </div>
                    <div class="profile-card" data-profile="aggressive">
                        <h3>–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π</h3>
                        <p>–ú–∞–∫—Å–∏–º—É–º —Ä–æ—Å—Ç–∞, –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫</p>
                    </div>
                </div>
                <button class="btn-next" disabled>–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step hidden" id="step-management" data-step="2">
            <div class="container">
                <h2>–¢–∏–ø —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –±–ª–∏–∂–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–µ.</p>
                <div class="toggle-group">
                    <label class="toggle-option active" data-type="passive">
                        <input type="radio" name="management" value="passive" checked>
                        <span>–ü–∞—Å—Å–∏–≤–Ω–æ–µ</span>
                    </label>
                    <label class="toggle-option" data-type="active">
                        <input type="radio" name="management" value="active">
                        <span>–ê–∫—Ç–∏–≤–Ω–æ–µ</span>
                    </label>
                </div>
                <button class="btn-prev">–ù–∞–∑–∞–¥</button>
                <button class="btn-next">–î–∞–ª–µ–µ</button>
            </div>
        </div>

        <div class="step hidden" id="step-allocation" data-step="3">
            <div class="container">
                <h2>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞</h2>
                <p>–°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π: <strong>1 000 000 ‚ÇΩ</strong></p>
                <div class="allocation-inputs">
                    <div class="alloc-item">
                        <label>–ê–∫—Ü–∏–∏ (%)</label>
                        <input type="number" min="0" max="100" value="0" id="alloc-stocks">
                    </div>
                    <div class="alloc-item">
                        <label>–û–±–ª–∏–≥–∞—Ü–∏–∏ (%)</label>
                        <input type="number" min="0" max="100" value="0" id="alloc-bonds">
                    </div>
                    <div class="alloc-item">
                        <label>ETF (%)</label>
                        <input type="number" min="0" max="100" value="0" id="alloc-etf">
                    </div>
                    <div class="alloc-item">
                        <label>–§—å—é—á–µ—Ä—Å—ã (%)</label>
                        <input type="number" min="0" max="100" value="0" id="alloc-futs">
                    </div>
                    <div class="alloc-item">
                        <label>–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ (%)</label>
                        <input type="number" min="0" max="100" value="0" id="alloc-crypto">
                    </div>
                </div>
                <div class="allocation-summary">
                    <p>–¢–µ–∫—É—â–∞—è —Å—É–º–º–∞: <span id="alloc-sum">0%</span> (<span id="alloc-remaining">100%</span> –¥–æ 100%)</p>
                </div>
                <button class="btn-prev">–ù–∞–∑–∞–¥</button>
                <button class="btn-next" id="btn-submit">–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å</button>
            </div>
        </div>

        <div class="step hidden result-step" id="step-result" data-step="4">
            <div class="container">
                <h2>–í–∞—à –±–∞–∑–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å</h2>
                <p>–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –º—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ.</p>
                <div class="asset-cards" id="asset-cards">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
                <div class="report-actions">
                    <button class="btn-download" id="btn-free-report">–°–∫–∞—á–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç</button>
                </div>
                <div class="premium-upsell">
                    <h3>–•–æ—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π PDF-–æ—Ç—á—ë—Ç?</h3>
                    <p>–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑, —Å—Ü–µ–Ω–∞—Ä–∏–∏, –Ω–∞–ª–æ–≥–æ–≤–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Äî –≤—Å–µ–≥–æ –∑–∞ <strong>290 ‚ÇΩ</strong></p>
                    <button class="btn-premium" id="btn-premium">–ü–æ–ª—É—á–∏—Ç—å –∑–∞ 290 ‚ÇΩ</button>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 –• –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>

    <button id="backToTop" class="back-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">‚Üë</button>

    <script>
        // === DEBUG MODE ‚Äî –í–†–ï–ú–ï–ù–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –û–ü–õ–ê–¢–´ ===
        const DEBUG_MODE = true; // ‚Üê true = –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ–ø–ª–∞—Ç—É, false = —Ä–µ–∞–ª—å–Ω–∞—è –æ–ø–ª–∞—Ç–∞

        // === State ===
        const state = {
            currentStep: 1,
            profile: null,
            management: 'passive',
            allocation: { stocks: 0, bonds: 0, etf: 0, futs: 0, crypto: 0 }
        };

        // === DOM Elements ===
        const steps = document.querySelectorAll('.step');
        const progressBarSteps = document.querySelectorAll('.progress-step');
        const progressLabel = document.getElementById('progressLabel');
        const allocInputs = {
            stocks: document.getElementById('alloc-stocks'),
            bonds: document.getElementById('alloc-bonds'),
            etf: document.getElementById('alloc-etf'),
            futs: document.getElementById('alloc-futs'),
            crypto: document.getElementById('alloc-crypto')
        };

        // === –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–û–õ–ï–ô –ù–ê –®–ê–ì–ï 3 ‚Äî –û–°–ù–û–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ===
        function updateAllocationFields() {
            const management = state.management;
            const profile = state.profile;

            const allowed = { stocks: false, bonds: false, etf: false, futs: false, crypto: false };

            if (management === 'passive') {
                // –¢–æ–ª—å–∫–æ ETF –ø—Ä–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ ‚Äî –í–ê–ñ–ù–û: –¥–∞–∂–µ –µ—Å–ª–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π!
                allowed.etf = true;
            } else {
                // –ê–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ‚Äî –ø–æ –ø—Ä–æ—Ñ–∏–ª—é
                if (profile === 'conservative') {
                    allowed.bonds = true;
                    allowed.etf = true;
                } else if (profile === 'balanced') {
                    allowed.stocks = true;
                    allowed.bonds = true;
                    allowed.etf = true;
                } else if (profile === 'aggressive') {
                    allowed.stocks = true;
                    allowed.bonds = true;
                    allowed.etf = true;
                    allowed.futs = true;
                    allowed.crypto = true;
                }
            }

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            Object.entries(allocInputs).forEach(([key, input]) => {
                const container = input.closest('.alloc-item');
                if (allowed[key]) {
                    input.disabled = false;
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ state (–µ—Å–ª–∏ –ø–æ–ª–µ —Å–Ω–æ–≤–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ)
                    input.value = state.allocation[key] || 0;
                } else {
                    input.disabled = true;
                    input.value = '0';
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É
            updateAllocation();

            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–æ–¥—Å–∫–∞–∑–∫–∞
            const hintEl = document.getElementById('step3-hint');
            if (hintEl) {
                let text = '';
                if (management === 'passive') {
                    text = '–ü—Ä–∏ –ø–∞—Å—Å–∏–≤–Ω–æ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ ETF.';
                } else if (profile === 'conservative') {
                    text = '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: –¥–æ—Å—Ç—É–ø–Ω—ã –æ–±–ª–∏–≥–∞—Ü–∏–∏ –∏ ETF.';
                } else if (profile === 'balanced') {
                    text = '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: –¥–æ—Å—Ç—É–ø–Ω—ã –∞–∫—Ü–∏–∏, –æ–±–ª–∏–≥–∞—Ü–∏–∏, ETF.';
                } else if (profile === 'aggressive') {
                    text = '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å: –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã.';
                } else {
                    text = '–í—ã–±–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.';
                }
                hintEl.textContent = text;
            }
        }

        // === –°–¢–ê–†–´–ï –§–£–ù–ö–¶–ò–ò ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∫—Ä–æ–º–µ updateAllocationFields –≤ –Ω—É–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö) ===

        function goToStep(step) {
            if (step < 1 || step > 4) return;
            state.currentStep = step;
            steps.forEach(s => s.classList.add('hidden'));
            document.querySelector(`.step[data-step="${step}"]`).classList.remove('hidden');
            progressBarSteps.forEach((el, i) => el.classList.toggle('active', i + 1 <= step));
            progressLabel.textContent = `–®–∞–≥ ${step} –∏–∑ 4`;

            // üîë –ù–û–í–û–ï: –ø—Ä–∏ –≤—Ö–æ–¥–µ –Ω–∞ —à–∞–≥ 3 ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ–ª–µ–π
            if (step === 3) {
                updateAllocationFields();
            }
        }

        function updateAllocation() {
            const sum = Object.values(allocInputs).reduce((acc, input) => acc + (parseFloat(input.value) || 0), 0);
            const remaining = 100 - sum;
            document.getElementById('alloc-sum').textContent = `${sum}%`;
            document.getElementById('alloc-remaining').textContent = `${Math.max(0, remaining)}%`;
            document.getElementById('btn-submit').disabled = sum !== 100;
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Äî –¥–∞–∂–µ –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã—Ö (–æ–Ω–∏ 0)
            Object.keys(allocInputs).forEach(k => {
                state.allocation[k] = parseFloat(allocInputs[k].value) || 0;
            });
        }

        function parseSheetCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];
            return lines.slice(1).map(line => {
                const cols = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(c => c.replace(/^"(.*)"$/, '$1').trim());
                return { ticker: cols[0] || '‚Äî', name: cols[1] || '‚Äî' };
            }).filter(i => i.ticker !== '‚Äî');
        }

        function renderPortfolio(instruments) {
            const container = document.getElementById('asset-cards');
            if (!container) return;

            const order = [
                { key: 'stocks', title: '–ê–∫—Ü–∏–∏', fields: ['–¢–∏–∫–µ—Ä', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–°–µ–∫—Ç–æ—Ä', '–°—Ç–∞—Ç—É—Å –≤ –∏–Ω–¥–µ–∫—Å–µ Moex', 'Smart-beta –∏–Ω–¥–µ–∫—Å –∞–∫—Ü–∏–π', '–î–æ–ª—è –≤ –ü–æ—Ä—Ç—Ñ–µ–ª–µ –∞–∫—Ü–∏–π, %'] },
                { key: 'bonds', title: '–û–±–ª–∏–≥–∞—Ü–∏–∏', fields: ['ISIN', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞, % –æ—Ç –Ω–æ–º–∏–Ω–∞–ª–∞', '–¢–∏–ø –æ–±–ª–∏–≥–∞—Ü–∏–∏', '–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (YTM), % –≥–æ–¥–æ–≤—ã—Ö', '–†–µ–π—Ç–∏–Ω–≥', 'Smart-beta –∏–Ω–¥–µ–∫—Å –æ–±–ª–∏–≥–∞—Ü–∏–π', '–î–æ–ª—è –≤ –ü–æ—Ä—Ç—Ñ–µ–ª–µ –æ–±–ª–∏–≥–∞—Ü–∏–π, %'] },
                { key: 'etf', title: 'ETF', fields: ['–¢–∏–∫–µ—Ä', '–ù–∞–∑–≤–∞–Ω–∏–µ –£–ö', '–¶–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', '–†–µ–≥–∏–æ–Ω', '–ö–ª–∞—Å—Å –∞–∫—Ç–∏–≤–æ–≤', 'Smart-beta –∏–Ω–¥–µ–∫—Å ETF', '–î–æ–ª—è –≤ –ü–æ—Ä—Ç—Ñ–µ–ª–µ ETF, %'] },
                { key: 'futs', title: '–§—å—é—á–µ—Ä—Å—ã', fields: ['–¢–∏–∫–µ—Ä', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', 'Smart-beta –∏–Ω–¥–µ–∫—Å —Ñ—å—é—á–µ—Ä—Å—ã', '–î–æ–ª—è –≤ –ü–æ—Ä—Ç—Ñ–µ–ª–µ —Ñ—å—é—á–µ—Ä—Å—ã, %'] },
                { key: 'crypto', title: '–ö—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞', fields: ['–¢–∏–∫–µ—Ä', '–ù–∞–∑–≤–∞–Ω–∏–µ', '–¶–µ–Ω–∞', '–í–∞–ª—é—Ç–∞', 'Smart-beta –∏–Ω–¥–µ–∫—Å –∫—Ä–∏–ø—Ç–æ', '–î–æ–ª—è –≤ –ü–æ—Ä—Ç—Ñ–µ–ª–µ –∫—Ä–∏–ø—Ç–æ, %'] }
            ];

            container.innerHTML = '';

            order.forEach(({ key, title, fields }) => {
                const pct = state.allocation[key] || 0;
                if (pct === 0) return;

                // üîë –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–æ—Ñ–∏–ª—é ‚Äî –û–°–¢–ê–í–õ–ï–ù–ê (–∫–∞–∫ –≤ –≤–∞—à–µ–º –∫–æ–¥–µ)
                if (state.profile === 'conservative' && ['stocks', 'crypto', 'futs'].includes(key)) return;
                if (state.profile === 'balanced' && ['crypto', 'futs'].includes(key)) return;

                const items = instruments[key] || [];
                const topItems = items.slice(0, key === 'stocks' ? 5 : 3);

                let tableHtml = `
                  <div class="asset-card full-width">
                    <h3>${title}</h3>
                    <table class="portfolio-table">
                      <thead>
                        <tr>${fields.map(f => `<th data-title="${f}">${f}</th>`).join('')}</tr>
                      </thead>
                      <tbody>
                        ${topItems.map(item => `
                          <tr>${fields.map(f => `<td>${item[f] || '‚Äî'}</td>`).join('')}</tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                `;

                container.insertAdjacentHTML('beforeend', tableHtml);
            });
        }

        async function loadAndRenderPortfolio() {
            const sheetNames = ['stocks', 'bonds', 'etf', 'futs', 'crypto'];
            const instruments = {};

            for (const sheet of sheetNames) {
                try {
                    const url = `/api/instruments?sheet=${encodeURIComponent(sheet)}`;
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    instruments[sheet] = data;
                } catch (e) {
                    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—Å—Ç–∞ "${sheet}":`, e);
                    instruments[sheet] = [];
                }
            }

            renderPortfolio(instruments);
            window._lastInstruments = instruments;
        }

        // === Event Listeners ‚Äî —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ ===

        document.querySelectorAll('.profile-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.profile-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                state.profile = card.dataset.profile;
                document.querySelector('.btn-next').disabled = false;

                // üîë –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ—à–ª–∏ –¥–∞–ª—å—à–µ
                if (state.currentStep >= 2) {
                    updateAllocationFields();
                }
            });
        });

        document.querySelectorAll('.toggle-option').forEach(opt => {
            opt.addEventListener('click', () => {
                document.querySelectorAll('.toggle-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                state.management = opt.dataset.type;

                // üîë –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è, –µ—Å–ª–∏ —É–∂–µ –Ω–∞ —à–∞–≥–µ ‚â•2
                if (state.currentStep >= 2) {
                    updateAllocationFields();
                }
            });
        });

        Object.values(allocInputs).forEach(input => {
            input.addEventListener('input', () => {
                let val = parseFloat(input.value);
                if (isNaN(val) || val < 0) input.value = 0;
                if (val > 100) input.value = 100;
                updateAllocation();
            });
        });

        document.querySelectorAll('.btn-next').forEach(btn => {
            btn.addEventListener('click', async () => {
                if (state.currentStep === 3) {
                    const sum = Object.values(state.allocation).reduce((a, b) => a + b, 0);
                    if (sum !== 100) return;
                }
                const nextStep = state.currentStep + 1;
                goToStep(nextStep);
                if (nextStep === 4) {
                    await loadAndRenderPortfolio();
                }
            });
        });

        document.querySelectorAll('.btn-prev').forEach(btn => {
            btn.addEventListener('click', () => goToStep(state.currentStep - 1));
        });

        // === Premium –∫–Ω–æ–ø–∫–∞ ‚Äî –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∫–∞–∫ –±—ã–ª–∞ ===
        document.getElementById('btn-premium')?.addEventListener('click', () => {
            if (!state.profile) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å');
                return;
            }

            if (DEBUG_MODE) {
                const email = 'debug@xinvest';
                const portfolioData = {
                    profile: state.profile === 'conservative' ? '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π' :
                        state.profile === 'balanced' ? '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π' :
                            state.profile === 'aggressive' ? '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π' : '‚Äî',
                    management: state.management === 'passive' ? '–ü–∞—Å—Å–∏–≤–Ω–æ–µ' : '–ê–∫—Ç–∏–≤–Ω–æ–µ',
                    allocation: state.allocation,
                    email: email
                };

                fetch('/api/webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Status: 0,
                        InvoiceId: 'DEBUG-' + Date.now(),
                        Email: email,
                        Data: JSON.stringify(portfolioData)
                    })
                })
                    .then(r => r.text())
                    .then(text => {
                        alert('‚úÖ PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + email + '\n(–≤ —Ä–µ–∂–∏–º–µ DEBUG)');
                        console.log('Webhook response:', text);
                    })
                    .catch(err => {
                        alert('‚ùå –û—à–∏–±–∫–∞: ' + err.message);
                        console.error('Webhook error:', err);
                    });
            } else {
                const email = document.getElementById('email').value?.trim();
                const consent = document.getElementById('consent')?.checked;

                if (!email || !/\S+@\S+\.\S+/.test(email)) {
                    alert('–£–∫–∞–∂–∏—Ç–µ email');
                    return;
                }
                if (!consent) {
                    alert('–î–∞–π—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ');
                    return;
                }

                const widget = new cp.CloudPayments();
                widget.charge(
                    {
                        publicId: '–≤–∞—à-public-id',
                        description: '–û—Ç—á—ë—Ç –æ—Ç –• –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏',
                        amount: 290,
                        currency: 'RUB',
                        invoiceId: 'IK-' + Date.now(),
                        accountId: email,
                        email: email,
                        data: JSON.stringify({
                            profile: state.profile === 'conservative' ? '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π' :
                                state.profile === 'balanced' ? '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π' :
                                    state.profile === 'aggressive' ? '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π' : '‚Äî',
                            management: state.management === 'passive' ? '–ü–∞—Å—Å–∏–≤–Ω–æ–µ' : '–ê–∫—Ç–∏–≤–Ω–æ–µ',
                            allocation: state.allocation,
                            email: email
                        })
                    },
                    () => alert('‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞! PDF –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ' + email),
                    (reason) => alert(reason === 'fail' ? '–ü–ª–∞—Ç—ë–∂ –æ—Ç–∫–ª–æ–Ω—ë–Ω' : '–û—Ç–º–µ–Ω–µ–Ω–æ')
                );
            }
        });

        // === Mobile & scroll ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
        const burger = document.getElementById('burgerBtn');
        const nav = document.getElementById('mainNav');
        burger?.addEventListener('click', () => {
            nav.classList.toggle('nav--active');
            burger.classList.toggle('burger--active');
        });
        document.querySelectorAll('.nav-link')?.forEach(link => {
            link.addEventListener('click', () => {
                nav.classList.remove('nav--active');
                burger?.classList.remove('burger--active');
            });
        });
        const backToTopBtn = document.getElementById('backToTop');
        window.addEventListener('scroll', () => {
            if (backToTopBtn) backToTopBtn.style.display = window.scrollY > 300 ? 'block' : 'none';
        });
        backToTopBtn?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

        // === –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ —à–∞–≥–µ 4 (–µ—Å–ª–∏ –µ—ë –Ω–µ—Ç –≤ —Ä–∞–∑–º–µ—Ç–∫–µ) ===
        const stepResult = document.getElementById('step-result');
        if (stepResult && !stepResult.querySelector('.btn-prev')) {
            const btnBack = document.createElement('button');
            btnBack.className = 'btn-prev';
            btnBack.textContent = '–ù–∞–∑–∞–¥';
            btnBack.addEventListener('click', () => goToStep(3));
            stepResult.querySelector('.container').appendChild(btnBack);
        }

        // üîë –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ ‚Äî –û–ü–¶–ò–û–ù–ê–õ–¨–ù–û (—É–¥–∞–ª–∏—Ç–µ, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)
        const stepAlloc = document.getElementById('step-allocation');
        if (stepAlloc && !document.getElementById('step3-hint')) {
            const hint = document.createElement('p');
            hint.id = 'step3-hint';
            hint.style.cssText = 'font-size: 0.9em; color: #666; background: #f8fafc; padding: 8px 12px; border-radius: 6px; margin-bottom: 16px;';
            stepAlloc.querySelector('.container').insertBefore(hint, stepAlloc.querySelector('.allocation-inputs'));
            updateAllocationFields(); // —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –∑–∞–ø–æ–ª–Ω–∏—Ç—å
        }

        // === Start ===
        goToStep(1);
    </script>
</body>
</html>